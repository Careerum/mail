humhub.module("mail.ConversationView",(function(t,e,n){var o=e("ui.widget").Widget,i=e("ui.loader"),r=e("client"),s=e("ui.additions"),a=e("util.object"),c=e("mail.notification"),l=e("ui.view");const u=e("rocketmailinitialview");var d=o.extend();d.prototype.init=function(){s.observe(this.$);var t=this;window.onresize=function(e){t.updateSize(!0)},this.getActiveMessageId()||this.setActiveMessageId(o.instance("#inbox").getFirstMessageId()),this.reload(),this.$.on("mouseenter",".mail-conversation-entry",(function(){n(this).find(".conversation-menu").show()})).on("mouseleave",".mail-conversation-entry",(function(){n(this).find(".conversation-menu").hide()}))},d.prototype.loader=function(t){!1!==t?i.set(this.$):i.reset(this.$)},d.prototype.markSeen=function(e){r.post(this.options.markSeenUrl,{data:{id:e}}).then((function(t){a.isDefined(t.messageCount)&&c.setMailMessageCount(t.messageCount)})).catch((function(e){t.log.error(e)}))},d.prototype.loadUpdate=function(){var t=this.$.find(".mail-conversation-entry:not(.own):last").data("entry-id"),e={id:this.getActiveMessageId(),from:t},o=this;r.get(this.options.loadUpdateUrl,{data:e}).then((function(t){t.html&&n(t.html).each((function(){o.appendEntry(n(this))}))}))},d.prototype.reply=function(e){var s=this;r.submit(e).then((function(e){e.success?s.appendEntry(e.content).then((function(){s.$.find(".time").timeago(),s.getReplyRichtext().$.trigger("clear"),s.scrollToBottom(),l.isSmall()||s.focus(),o.instance("#inbox").updateEntries([s.getActiveMessageId()]),s.setLivePollInterval()})):t.log.error(e,!0)})).catch((function(e){t.log.error(e,!0)})).finally((function(t){i.reset(n(".reply-button")),e.finish()}))},d.prototype.setLivePollInterval=function(){e("live").setDelay(5)},d.prototype.getReplyRichtext=function(){return o.instance(this.$.find(".ProsemirrorEditor"))},d.prototype.focus=function(t){this.getReplyRichtext().focus()},d.prototype.canLoadMore=function(){return!this.options.isLast},d.prototype.reload=function(){this.getActiveMessageId()&&this.loadMessage(this.getActiveMessageId())},d.prototype.addUser=function(e){var n=this;r.submit(e).then((function(e){e.result?n.$.find("#mail-conversation-header").html(e.result):e.error&&t.log.error(e,!0)})).catch((function(e){t.log.error(e,!0)}))},d.prototype.appendEntry=function(t){var e=this,o=n(t);if(e.$.find('[data-entry-id="'+o.data("entryId")+'"]').length)return Promise.resolve();var i=o.not("script, link").filter((function(){return 1===this.nodeType}));return i.css("opacity",0),this.getListNode().append(o),new Promise((function(t,n){i.css("opacity",1).fadeIn("fast",(function(){e.onUpdate(),setTimeout((function(){e.scrollToBottom()}),100),t()}))}))},d.prototype.loadMessage=function(e){var i=a.isNumber(e)?e:e.$trigger.data("message-id"),s=this;this.loader(),r.get(this.options.loadMessageUrl,{data:{id:i}}).then((function(t){s.setActiveMessageId(i),s.options.isLast=!1;var n=o.instance("#inbox");if(n.updateActiveItem(),n.hide(),e.$trigger&&history&&history.replaceState){var r=e.$trigger.data("action-url");r&&history.replaceState(null,null,r)}return s.$.css("visibility","hidden"),s.updateContent(t.html)})).then((function(){return s.initScroll()})).catch((function(e){t.log.error(e,!0)})).finally((function(){s.scrollToBottom(),s.loader(!1),s.$.css("visibility","visible"),s.initReplyRichText();const t=n(".chat-title-wrap"),e=t.children("span");s.makeScrollable(t,e);const o=n(".chat-occupation-wrap"),i=o.children(".rocketcore-user-occupation");o.on("mouseenter",(function(){s.makeScrollable(o,i,!1)})),o.on("mouseleave").on("mouseleave",(function(){o.animate({scrollLeft:0},3500)}))}))},d.prototype.makeScrollable=function(t,e,n=!0,o=1500,i=3500){if(t.innerWidth()<e.innerWidth()){const e=t.offset().left,r=()=>{setTimeout((()=>{t.animate({scrollLeft:e},i,(()=>{setTimeout((()=>t.animate({scrollLeft:0},i,(function(){n&&r()}))),o)}))}),o)};r()}},d.prototype.initReplyRichText=function(){var t=this;window.ResizeObserver&&new ResizeObserver((function(e){t.updateSize(t.isScrolledToBottom(100))})).observe(t.getReplyRichtext().$[0]);t.focus()},d.prototype.isScrolledToBottom=function(t){if(!this.getListNode().length)return!1;t=t||0;var e=this.getListNode()[0];return e.scrollHeight-e.offsetHeight-e.scrollTop<=t},d.prototype.initScroll=function(){if(window.IntersectionObserver){var t=this.$.find(".conversation-entry-list"),e=n('<div class="conversation-stream-end"></div>');t.prepend(e);var o=this,r=new IntersectionObserver((function(e){o.preventScrollLoading()||e.length&&e[0].isIntersecting&&(i.prepend(t),o.loadMore().finally((function(){i.reset(t),o.scrollToBottom()})))}),{root:t[0],rootMargin:"50px"});return this.assureScroll().then((function(){r.observe(e[0]),l.isLarge()&&o.getListNode().niceScroll({cursorwidth:"7",cursorborder:"",cursorcolor:"#555",cursoropacitymax:"0.2",nativeparentscrolling:!1,railpadding:{top:0,right:0,left:0,bottom:0}})}))}},d.prototype.loadMore=function(){var e=this,o={id:this.getActiveMessageId(),from:this.$.find(".mail-conversation-entry:first").data("entryId")};return r.get(this.options.loadMoreUrl,{data:o}).then((function(t){if(t.result){var o=n(t.result).hide();e.$.find(".conversation-entry-list").find(".conversation-stream-end").after(o),o.fadeIn()}e.options.isLast=!t.result||t.isLast})).catch((function(e){t.log.error(e,!0)}))},d.prototype.preventScrollLoading=function(){return this.scrollLock||!this.canLoadMore()},d.prototype.canLoadMore=function(){return!this.options.isLast},d.prototype.assureScroll=function(){var t=this,e=this.$.find(".conversation-entry-list");return e[0].offsetHeight>=e[0].scrollHeight&&this.canLoadMore()?this.loadMore().then((function(){return t.assureScroll()})).catch((function(){return Promise.resolve()})):t.scrollToBottom()},d.prototype.updateContent=function(t){var e=this;return new Promise((function(n){e.$.html(t),n()}))},d.prototype.getActiveMessageId=function(){return this.options.messageId},d.prototype.setActiveMessageId=function(t){this.options.messageId=t},d.prototype.scrollToBottom=function(){var t=this;return new Promise((function(e){setTimeout((function(){t.$.imagesLoaded((function(){var n=t.getListNode();n.length&&t.updateSize(!1).then((function(){n.scrollTop(n[0].scrollHeight),setTimeout((()=>{if(!t.isScrolledToBottom(100))return t.scrollToBottom()}),100),e()}))}))}))}))},d.prototype.updateSize=function(t){var e=this;return new Promise((function(n){setTimeout((function(){var o=e.$.find(".conversation-entry-list");if(o.length){var i=e.getReplyRichtext().$.innerHeight();o.css("margin-bottom",i+5+"px");var r=e.$.find(".conversation-entry-list").offset().top,s=window.innerHeight-r-i-(l.isSmall()?20:30)+"px";o.css("height",s),o.css("max-height",s),!1!==t&&e.scrollToBottom(),n()}}),100)}))},d.prototype.getListNode=function(){return this.$.find(".conversation-entry-list")},d.prototype.onUpdate=function(){l.isLarge()&&this.getListNode().getNiceScroll().resize()},d.prototype.isLastMessageMine=function(){return this.$.find(".mail-conversation-entry").last().hasClass("own")};d.prototype.close=function(){this.setActiveMessageId(null),this.$.html(""),function(){const t=new URL(window.location);t.searchParams.delete("id"),window.history.pushState({},"",t)}(),l.isSmall()&&u.closeConversation()},t.export=d})),humhub.module("mail.ConversationEntry",(function(t,e,n){var o=e("ui.widget").Widget.extend();o.prototype.replace=function(t){var e=this,o=n(t).hide();this.$.fadeOut((function(){n(this).replaceWith(o),e.$=o,e.$.fadeIn("slow")}))},o.prototype.remove=function(){this.$.fadeToggle("slow",(function(){n(this).remove()}))},t.export=o})),humhub.module("mail.inbox",(function(t,e,n){var o=e("ui.widget").Widget,i=e("ui.filter").Filter,r=e("ui.view"),s=e("ui.loader"),a=e("client"),c=i.extend();c.prototype.triggerChange=function(){this.super("triggerChange"),this.updateFilterCount()},c.prototype.updateFilterCount=function(){var t=this.getActiveFilterCount(),e=this.$.find("#conversation-filter-link"),o=e.find(".filterCount");t?(o.length||(o=n('<small class="filterCount"></small>').insertBefore(e.find(".caret"))),o.html(" <b>("+t+")</b> ")):o.length&&o.remove()};var l=o.extend();l.prototype.init=function(){this.filter=o.instance("#mail-filter-root"),this.initScroll();var t=this;this.filter.off("afterChange.inbox").on("afterChange.inbox",(function(){t.reload().then((function(){t.updateActiveItem()}))})),r.isLarge()&&this.$.niceScroll({cursorwidth:"7",cursorborder:"",cursorcolor:"#555",cursoropacitymax:"0.2",nativeparentscrolling:!1,railpadding:{top:0,right:3,left:0,bottom:0}}),this.$.on("click",".entry",(function(){t.$.find(".entry").removeClass("selected"),n(this).addClass("selected")}))},l.prototype.updateEntries=function(e){var o=this;e.length&&a.get(this.options.updateEntriesUrl,{data:{ids:e}}).then((function(t){t.result&&(n.each(t.result,(function(t,e){var i=o.getEntry(t);i.length?i.replaceWith(e):n(e).prependTo(o.$)})),o.updateActiveItem())})).catch((function(e){t.log.error(e)}))},l.prototype.getEntry=function(t){return this.$.find('[data-message-preview="'+t+'"]')},l.prototype.initScroll=function(){if(window.IntersectionObserver){var t=n('<div class="inbox-stream-end"></div>');this.$.append(t);var e=this,o=new IntersectionObserver((function(t){e.preventScrollLoading()||t.length&&t[0].isIntersecting&&(s.append(e.$),e.loadMore().finally((function(){s.reset(e.$)})))}),{root:this.$[0],rootMargin:"50px"});this.assureScroll().then((function(){o.observe(t[0])}))}n(".filterInput").off("select2:close").on("select2:close",(function(t){const e="scroll.select2";n(t.target).parents().off(e),n(window).off(e)}))},l.prototype.assureScroll=function(){var t=this;return this.$[0].offsetHeight>=this.$[0].scrollHeight&&this.canLoadMore()?(this.scrollLock=!0,this.loadMore().then((function(){return t.assureScroll()})).catch((function(){return Promise.resolve()}))):Promise.resolve()},l.prototype.loadMore=function(){var e=this;return new Promise((function(o,i){var r=e.filter.getFilterMap();r.from=e.getLastMessageId(),a.get(e.options.loadMoreUrl,{data:r}).then((function(t){t.result&&(n(t.result).insertBefore(".inbox-stream-end"),e.$.find(".inbox-stream-end").append()),e.options.isLast=!t.result||t.isLast,e.updateActiveItem(),o()})).catch((function(e){t.log.error(e,!0),i()})).finally((function(){e.scrollLock=!1}))}))},l.prototype.preventScrollLoading=function(){return this.scrollLock||!this.canLoadMore()},l.prototype.canLoadMore=function(){return!this.options.isLast},l.prototype.getReloadOptions=function(){return{data:this.filter.getFilterMap()}},l.prototype.updateActiveItem=function(){if(null!==o.instance("#mail-conversation-root")){var t=o.instance("#mail-conversation-root").getActiveMessageId();this.$.find(".entry").removeClass("selected"),this.$.find(".entry.selected").find(".new-message-badge").hide(),this.$.find(".entry").removeClass("selected");var e=this.$.find('[data-message-preview="'+t+'"]');e.length&&(e.removeClass("unread").addClass("selected").find(".new-message-badge").hide(),e.find(".chat-count").hide())}},l.prototype.getFirstMessageId=function(){return this.$.find(".entry:first").data("messagePreview")},l.prototype.getLastMessageId=function(){return this.$.find(".entry:last").data("messagePreview")},l.prototype.hide=function(){return new Promise((function(t){r.isSmall()&&n(".inbox-wrapper").slideUp((function(){n("#mail-conversation-root").length&&o.instance("#mail-conversation-root").updateSize(),t()})),t()}))},l.prototype.show=function(){return new Promise((function(t){r.isSmall()&&n(".inbox-wrapper").slideDown((function(){n("#mail-conversation-root").length&&o.instance("#mail-conversation-root").updateSize(),t()})),t()}))};t.export({ConversationList:l,Filter:c,setTagFilter:function(t){o.instance("#inbox").show().then((function(){n("#mail-filter-menu").collapse("show"),o.instance("#inbox-tag-picker").setSelection([{id:t.$trigger.data("tagId"),text:t.$trigger.data("tagName"),image:t.$trigger.data("tagImage")}])}))},toggleInbox:function(){r.isSmall()&&n(".inbox-wrapper").slideToggle((function(){o.instance("#mail-conversation-root").updateSize()}))}})})),humhub.module("mail.conversation",(function(t,e,n){var o=e("ui.widget").Widget,i=e("ui.modal"),r=e("client"),s=e("event"),a=e("mail.notification"),c=e("user"),l=function(t){return o.instance('.mail-conversation-entry[data-entry-id="'+t+'"]')},u=function(t){return n("#mail-conversation-overview").find('[data-message-preview="'+t+'"]')};t.export({init:function(){s.on("humhub:modules:mail:live:NewUserMessage",(function(t,e){if(n("#inbox").length){var i=o.instance("#mail-conversation-root"),r=!1,s=[];e.forEach((function(t){var e=t.data.user_guid==c.guid();if(s.push(t.data.message_id),!r&&i&&i.options.messageId==t.data.message_id)i.loadUpdate(),r=!0,i.markSeen(t.data.message_id);else if(!e&&i){var n=u(t.data.message_id);n.is(".selected")||n.find(".new-message-badge").show()}})),o.instance("#inbox").updateEntries(s)}})).on("humhub:modules:mail:live:UserMessageDeleted",(function(t,e,o){n("#inbox").length&&e.forEach((function(t){var e=l(t.data.entry_id);e&&e.remove(),a.setMailMessageCount(t.data.count)}))}))},leave:function(e){r.post(e).then((function(t){t.redirect&&r.pjax.redirect(t.redirect)})).catch((function(e){t.log.error(e,!0)}))},submitEditEntry:function(e){i.submit(e).then((function(n){if(n.success){var o=l(e.$trigger.data("entry-id"));o&&setTimeout((function(){o.replace(n.content)}),300)}else t.log.error(null,!0)})).catch((function(e){t.log.error(e,!0)}))},deleteEntry:function(e){var n=l(e.$trigger.data("entry-id"));n?r.post(n.options.deleteUrl).then((function(t){i.global.close(),t.success&&setTimeout((function(){n.remove()}),1e3)})).catch((function(e){t.log.error(e,!0)})):t.log.error(null,!0)}})}));