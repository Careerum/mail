humhub.module("mail.ConversationView",function(r,t,s){var a=t("ui.widget").Widget,o=t("ui.loader"),c=t("client"),i=t("ui.additions"),e=t("util.object"),n=t("mail.notification"),l=t("ui.view"),d=a.extend();d.prototype.init=function(){i.observe(this.$);var e=this;window.onresize=function(t){e.updateSize(!0)},l.isSmall()||this.reload(),this.$.on("mouseenter",".mail-conversation-entry",function(){s(this).find(".conversation-menu").show()}).on("mouseleave",".mail-conversation-entry",function(){s(this).find(".conversation-menu").hide()}),this.detectOpenedDialog()},d.prototype.loader=function(t){!1!==t?o.set(this.$):o.reset(this.$)},d.prototype.markSeen=function(t){c.post(this.options.markSeenUrl,{data:{id:t}}).then(function(t){e.isDefined(t.messageCount)&&n.setMailMessageCount(t.messageCount)}).catch(function(t){r.log.error(t)})},d.prototype.loadUpdate=function(){var t=this.$.find(".mail-conversation-entry:not(.own):last").data("entry-id"),t={id:this.getActiveMessageId(),from:t},e=this;c.get(this.options.loadUpdateUrl,{data:t}).then(function(t){t.html&&s(t.html).each(function(){e.appendEntry(s(this))})})},d.prototype.reply=function(e){var i=this;c.submit(e).then(function(t){t.success?i.appendEntry(t.content).then(function(){i.$.find(".time").timeago();var t=i.getReplyRichtext();t&&t.$.trigger("clear"),i.scrollToBottom(),l.isSmall()||i.focus(),a.instance("#inbox").updateEntries([i.getActiveMessageId()]),i.setLivePollInterval()}):r.log.error(t,!0)}).catch(function(t){r.log.error(t,!0)}).finally(function(t){o.reset(s(".reply-button")),e.finish()})},d.prototype.setLivePollInterval=function(){t("live").setDelay(5)},d.prototype.getReplyRichtext=function(){return a.instance(this.$.find(".ProsemirrorEditor"))},d.prototype.focus=function(t){if(l.isSmall())return Promise.resolve();var e=this.getReplyRichtext();e&&e.focus()},d.prototype.canLoadMore=function(){return!this.options.isLast},d.prototype.reload=function(){this.getActiveMessageId()&&this.loadMessage(this.getActiveMessageId())},d.prototype.addUser=function(t){var e=this;c.submit(t).then(function(t){t.result?e.$.find("#mail-conversation-header").html(t.result):t.error&&r.log.error(t,!0)}).catch(function(t){r.log.error(t,!0)})},d.prototype.appendEntry=function(t){var i=this,t=s(t);if(i.$.find('[data-entry-id="'+t.data("entryId")+'"]').length)return Promise.resolve();var n=t.not("script, link").filter(function(){return 1===this.nodeType});return n.css("opacity",0),this.getListNode().append(t),new Promise(function(t,e){n.css("opacity",1).fadeIn("fast",function(){i.onUpdate(),setTimeout(function(){i.scrollToBottom()},100),t()})})},d.prototype.loadMessage=function(i){l.isSmall()&&s(".messages").addClass("shown");var n=e.isNumber(i)?i:i.$trigger.data("message-id"),o=this;this.loader(),c.get(this.options.loadMessageUrl,{data:{id:n}}).then(function(t){var e;return o.setActiveMessageId(n),o.options.isLast=!1,a.instance("#inbox").updateActiveItem(),i.$trigger&&history&&history.replaceState&&((e=i.$trigger.data("action-url"))&&history.replaceState(null,null,e)),o.$.css("visibility","hidden"),o.updateContent(t.html)}).then(function(){return o.initScroll()}).catch(function(t){r.log.error(t,!0)}).finally(function(){o.loader(!1),o.$.css("visibility","visible"),o.initReplyRichText(),o.initMessageTitle()})},d.prototype.initMessageTitle=function(){const t=s(".chat-title-wrap"),e=t.find("span");if(t.innerWidth()<e.innerWidth()){const i=t.offset().left,n=()=>{setTimeout(()=>{t.animate({scrollLeft:i},3500,()=>{setTimeout(()=>t.animate({scrollLeft:0},3500,n),1500)})},1500)};n()}},d.prototype.initReplyRichText=function(){var t,e,i=this;window.ResizeObserver&&(t=new ResizeObserver(function(t){i.updateSize(i.isScrolledToBottom(100))}),(e=i.getReplyRichtext())&&t.observe(e.$[0])),i.focus()},d.prototype.isScrolledToBottom=function(t){if(!this.getListNode().length)return!1;t=t||0;var e=this.getListNode()[0];return e.scrollHeight-e.offsetHeight-e.scrollTop<=t},d.prototype.initScroll=function(){var e,t,i,n;if(window.IntersectionObserver)return e=this.$.find(".conversation-entry-list"),t=s('<div class="conversation-stream-end"></div>'),e.prepend(t),i=this,n=new IntersectionObserver(function(t){i.preventScrollLoading()||t.length&&t[0].isIntersecting&&(o.prepend(e),i.loadMore().finally(function(){o.reset(e),i.scrollToBottom()}))},{root:e[0],rootMargin:"50px"}),this.assureScroll().then(function(){n.observe(t[0]),l.isLarge()&&i.getListNode().niceScroll({cursorwidth:"7",cursorborder:"",cursorcolor:"#555",cursoropacitymax:"0.2",nativeparentscrolling:!1,railpadding:{top:0,right:0,left:0,bottom:0}})})},d.prototype.loadMore=function(){var i=this,t={id:this.getActiveMessageId(),from:this.$.find(".mail-conversation-entry:first").data("entryId")};return c.get(this.options.loadMoreUrl,{data:t}).then(function(t){var e;t.result&&(e=s(t.result).hide(),i.$.find(".conversation-entry-list").find(".conversation-stream-end").after(e),e.fadeIn()),i.options.isLast=!t.result||t.isLast}).catch(function(t){r.log.error(t,!0)})},d.prototype.preventScrollLoading=function(){return this.scrollLock||!this.canLoadMore()},d.prototype.canLoadMore=function(){return!this.options.isLast},d.prototype.assureScroll=function(){var t=this,e=this.$.find(".conversation-entry-list");return e[0].offsetHeight>=e[0].scrollHeight&&this.canLoadMore()?this.loadMore().then(function(){return t.assureScroll()}).catch(function(){return Promise.resolve()}):t.scrollToBottom()},d.prototype.updateContent=function(e){var i=this;return new Promise(function(t){i.$.html(e),t()})},d.prototype.getActiveMessageId=function(){return this.options.messageId},d.prototype.setActiveMessageId=function(t){this.options.messageId=t},d.prototype.scrollToBottom=function(){var i=this;return new Promise(function(e){setTimeout(function(){i.$.imagesLoaded(function(){var t=i.getListNode();t.length&&i.updateSize(!1).then(function(){t.scrollTop(t[0].scrollHeight),setTimeout(()=>{if(!i.isScrolledToBottom())return i.scrollToBottom()},100),e()})})})})},d.prototype.updateSize=function(o){var r=this;return new Promise(function(n){setTimeout(function(){var t,e,i=r.$.find(".conversation-entry-list");i.length&&(t=(t=r.getReplyRichtext())?t.$.innerHeight():0,i.css("margin-bottom",t+5+"px"),e=r.$.find(".conversation-entry-list").offset().top,e=window.innerHeight-e-t-(l.isSmall()?20:30)+"px",i.css("height",e),i.css("max-height",e),!1!==o&&r.scrollToBottom(),n())},100)})},d.prototype.getListNode=function(){return this.$.find(".conversation-entry-list")},d.prototype.onUpdate=function(){l.isLarge()&&this.getListNode().getNiceScroll().resize()},d.prototype.detectOpenedDialog=function(){if(l.isSmall()){const e=new URLSearchParams(window.location.search);var t;e.has("id")&&(t=e.get("id"),s(".messages").addClass("shown"),this.loadMessage(parseInt(t)))}},r.export=d}),humhub.module("mail.ConversationEntry",function(t,e,n){e=e("ui.widget").Widget.extend();e.prototype.replace=function(t){var e=this,i=n(t).hide();this.$.fadeOut(function(){n(this).replaceWith(i),e.$=i,e.$.fadeIn("slow")})},e.prototype.remove=function(){this.$.fadeToggle("slow",function(){n(this).remove()})},t.export=e}),humhub.module("mail.inbox",function(o,t,r){var i=t("ui.widget").Widget,e=t("ui.filter").Filter,n=t("ui.view"),s=t("ui.loader"),a=t("client"),t=e.extend(),e=(t.prototype.triggerChange=function(){this.super("triggerChange"),this.updateFilterCount()},t.prototype.updateFilterCount=function(){var t=this.getActiveFilterCount(),e=this.$.find("#conversation-filter-link"),i=e.find(".filterCount");t?(i=i.length?i:r('<small class="filterCount"></small>').insertBefore(e.find(".caret"))).html(" <b>("+t+")</b> "):i.length&&i.remove()},i.extend());e.prototype.init=function(){this.filter=i.instance("#mail-filter-root"),this.initScroll();var t=this;this.filter.off("afterChange.inbox").on("afterChange.inbox",function(){t.reload().then(function(){t.updateActiveItem()})}),n.isLarge()&&this.$.niceScroll({cursorwidth:"7",cursorborder:"",cursorcolor:"#555",cursoropacitymax:"0.2",nativeparentscrolling:!1,railpadding:{top:0,right:3,left:0,bottom:0}}),this.$.on("click",".entry",function(){t.$.find(".entry").removeClass("selected"),r(this).addClass("selected")})},e.prototype.updateEntries=function(t){var i=this;t.length&&a.get(this.options.updateEntriesUrl,{data:{ids:t}}).then(function(t){t.result&&(r.each(t.result,function(t,e){t=i.getEntry(t);t.length?t.replaceWith(e):r(e).prependTo(i.$)}),i.updateActiveItem())}).catch(function(t){o.log.error(t)})},e.prototype.getEntry=function(t){return this.$.find('[data-message-preview="'+t+'"]')},e.prototype.initScroll=function(){var t,e,i;window.IntersectionObserver&&(t=r('<div class="inbox-stream-end"></div>'),this.$.append(t),e=this,i=new IntersectionObserver(function(t){e.preventScrollLoading()||t.length&&t[0].isIntersecting&&(s.append(e.$),e.loadMore().finally(function(){s.reset(e.$)}))},{root:this.$[0],rootMargin:"50px"}),this.assureScroll().then(function(){i.observe(t[0])}))},e.prototype.assureScroll=function(){var t=this;return this.$[0].offsetHeight>=this.$[0].scrollHeight&&this.canLoadMore()?this.loadMore().then(function(){return t.assureScroll()}).catch(function(){return Promise.resolve()}):Promise.resolve()},e.prototype.loadMore=function(){var n=this;return new Promise(function(e,i){var t=n.filter.getFilterMap();t.from=n.getLastMessageId(),a.get(n.options.loadMoreUrl,{data:t}).then(function(t){t.result&&(r(t.result).insertBefore(".inbox-stream-end"),n.$.find(".inbox-stream-end").append()),n.options.isLast=!t.result||t.isLast,n.updateActiveItem(),e()}).catch(function(t){o.log.error(t,!0),i()}).finally(function(){n.scrollLock=!1})})},e.prototype.preventScrollLoading=function(){return this.scrollLock||!this.canLoadMore()},e.prototype.canLoadMore=function(){return!this.options.isLast},e.prototype.getReloadOptions=function(){return{data:this.filter.getFilterMap()}},e.prototype.updateActiveItem=function(){var t=i.instance("#mail-conversation-root").getActiveMessageId(),t=(this.$.find(".entry").removeClass("selected"),this.$.find(".entry.selected").find(".new-message-badge").hide(),this.$.find(".entry").removeClass("selected"),this.$.find('[data-message-preview="'+t+'"]'));t.length&&t.removeClass("unread").addClass("selected").find(".new-message-badge").hide()},e.prototype.getFirstMessageId=function(){return this.$.find(".entry:first").data("messagePreview")},e.prototype.getLastMessageId=function(){return this.$.find(".entry:last").data("messagePreview")},e.prototype.hide=function(){var e=r(".inbox-wrapper");return new Promise(function(t){n.isSmall()&&e.length&&r("#mail-conversation-root").length&&i.instance("#mail-conversation-root").updateSize(),t()})},e.prototype.show=function(){var e=r(".inbox-wrapper");return new Promise(function(t){n.isSmall()&&e.length&&r("#mail-conversation-root").length&&i.instance("#mail-conversation-root").updateSize(),t()})};o.export({ConversationList:e,Filter:t,setTagFilter:function(t){i.instance("#inbox").show().then(function(){r("#mail-filter-menu").collapse("show"),i.instance("#inbox-tag-picker").setSelection([{id:t.$trigger.data("tagId"),text:t.$trigger.data("tagName"),image:t.$trigger.data("tagImage")}])})},toggleInbox:function(){}})}),humhub.module("mail.conversation",function(n,t,r){function o(t){return s.instance('.mail-conversation-entry[data-entry-id="'+t+'"]')}var s=t("ui.widget").Widget,a=t("ui.modal"),i=t("client"),e=t("event"),c=t("mail.notification"),l=t("user");n.export({init:function(){e.on("humhub:modules:mail:live:NewUserMessage",function(t,e){var i,n,o;r("#inbox").length&&(i=s.instance("#mail-conversation-root"),n=!1,o=[],e.forEach(function(t){var e=t.data.user_guid==l.guid();o.push(t.data.message_id),!n&&i&&i.options.messageId==t.data.message_id?(i.loadUpdate(),n=!0,i.markSeen(t.data.message_id)):!e&&i&&(e=t.data.message_id,(t=r("#mail-conversation-overview").find('[data-message-preview="'+e+'"]')).is(".selected")||t.find(".new-message-badge").show())}),s.instance("#inbox").updateEntries(o))}).on("humhub:modules:mail:live:UserMessageDeleted",function(t,e,i){r("#inbox").length&&e.forEach(function(t){var e=o(t.data.entry_id);e&&e.remove(),c.setMailMessageCount(t.data.count)})})},leave:function(t){i.post(t).then(function(t){t.redirect&&i.pjax.redirect(t.redirect)}).catch(function(t){n.log.error(t,!0)})},submitEditEntry:function(i){a.submit(i).then(function(t){var e;t.success?(e=o(i.$trigger.data("entry-id")))&&setTimeout(function(){e.replace(t.content)},300):n.log.error(null,!0)}).catch(function(t){n.log.error(t,!0)})},deleteEntry:function(t){var e=o(t.$trigger.data("entry-id"));e?i.post(e.options.deleteUrl).then(function(t){a.global.close(),t.success&&setTimeout(function(){e.remove()},1e3)}).catch(function(t){n.log.error(t,!0)}):n.log.error(null,!0)}})}),humhub.module("mail.reply",function(o,t,r){function e(t=[]){if(t.length<=2)return!1;(s||r(a.messagesRoot)).find(a.convEntryContent).each(function(t,e){e=r(e);if(!!e.closest(".mail-conversation-entry").find(".profile-disable").length)return!1;if(e.find(a.mailAddonRoot).length)return!0;var i=g(),n=f();i.appendChild(n),e.append(i)})}var i,n,s,a={messagesRoot:"#mail-conversation-root",replyButton:".rocketmailreply-btn",convEntry:".mail-conversation-entry",convEntryContent:".mail-conversation-entry .content",convEntriesList:".conversation-entry-list",mailAddonRoot:".rocketcore-mail-addon-container",mailAddonRootEntry:".rocketcore-mail-addon-entry",replyBtn:".rocketmailreply-btn",editor:".ProsemirrorEditor",messageDom:"[data-ui-richtext]"},c=t("ui.widget").Widget,l=t("ui.richtext"),d=t("util").url,t=c.extend(),u=(t.prototype.init=function(){this.api=i,this.editor=this._getEditor(),this.domParser=this.api.model.DOMParser.fromSchema(this.editor.view.state.schema)},t.prototype.handle=function(){this.clearEditor(),this.pasteEditor(this.getReplyCut()),this.fixEmptyBlock(),this.focusEditor()},t.prototype.pasteEditor=function(t,e=1){e=this.editor.view.state.tr.insert(e,t);this.editor.view.dispatch(e)},t.prototype.fixEmptyBlock=function(){var t=this.editor.view,e=t.state.doc;t.dispatch(t.state.tr.setSelection(this.api.state.TextSelection.near(e.resolve(e.content.size-4)))),this.api.commands.joinBackward(t.state,t.dispatch,t)},t.prototype.clearEditor=function(){this.editor.clear();var t=this.editor.view.state.tr.insert(0,this.editor.parser.parse(">"));this.editor.view.dispatch(t)},t.prototype.focusEditor=function(){var t=this.api.state.Selection.atEnd(this.editor.view.state.doc),t=this.editor.view.state.tr.setSelection(t);this.editor.view.focus(),this.editor.view.dispatch(t.scrollIntoView())},t.prototype.getNodesContent=function(){return this.domParser.parse(this._getDomNode())},t.prototype.getReplyCut=function(){var t=this.stripBlockquoteFromBeginning(this.getNodesContent());if(t.nodeSize<256)return t;var t=t.cut(0,256),e=this.editor.view.state.schema,e=e.node("paragraph",null,[e.text("...")]);return t.content.addToEnd(e)},t.prototype.stripBlockquoteFromBeginning=function(t){return t.content.size&&"blockquote"===t.content.content[0].type.name?t.cut(t.content.content[0].nodeSize):t},t.prototype._getEditor=function(){return c.instance(r(a.messagesRoot).find(a.editor)).editor},t.prototype._getDomNode=function(){return this.$.closest(a.convEntryContent).find(a.messageDom)[0]},c.extend()),p=(u.prototype.init=function(){this.originalMessageId=this._findOriginalMessageId()},u.prototype.scrollToOriginalMessage=function(){},!(u.prototype._findOriginalMessageId=function(){})),h=function(t){t.preventDefault(),c.instance(this).handle()},f=function(){var t=document.createElement("div"),e=document.createElement("button"),i=document.createElement("span"),n=o.text("reply")||"Reply";return i.innerText=n,t.classList.add(a.mailAddonRootEntry.replace(".","")),e.classList.add(a.replyButton.replace(".","")),e.dataset.uiWidget="mail.reply.MailReplyButton",e.title=n,e.appendChild(i),t.appendChild(e),t},g=function(){var t=document.createElement("div");return t.classList.add(a.mailAddonRoot.replace(".","")),t};o.export({initOnPjaxLoad:!0,init:function(){return o.log.debug("Trying to initialize"),(t=d.getUrlParameter("r"))&&-1<decodeURIComponent(t).indexOf("mail/mail")||-1<location.pathname.indexOf("mail/mail")?p?(o.log.debug("Already initialized"),!0):(i=l.prosemirror.api,s=r(a.messagesRoot),(n=n||new MutationObserver(e)).observe(s[0],{childList:!0,subtree:!0}),r(document).on("click",a.replyButton,h),p=!0,void o.log.debug("Module initialized")):p?(o.log.debug("Module was initialized before, but the current page is not managed"),n.disconnect(),p=!1,r(document).off("click",a.replyButton,h),void o.log.debug("Module disconnected")):(o.log.debug("Can't initialize - the current page is not managed"),!1);var t},initReplyButton:e,MailReply:u,MailReplyButton:t})}),humhub.module("mail.draft",function(i,t,o){var e="#mail-conversation-root",n=".ProsemirrorEditor",r="mail:draft:changed",s=t("ui.widget").Widget,a=t("util").url,c=t("ui.richtext");function l(){this.key="mail:conversation:drafts",this.internalStorage=window.localStorage||window.sessionStorage,null===this.internalStorage.getItem(this.key)&&this._saveList({})}function d(t){var e,i,n,o,r,s;y(t)&&(t=(e=m().editor).view,i=v(),(n=b(i))&&e.isEmpty()&&(n=e.view.state.tr.insert(0,e.parser.parse(n)),e.view.dispatch(n),g.commands.joinBackward(t.state,t.dispatch,t)),e.on("keyup mouseup",(o=function(){var t=e.serializer.serialize(e.view.state.doc);p.set(i,t)},r=1e3,s=null,function(){s=s||setTimeout(function(){o(),s=null},r)})),e.$.on("clear",function(){p.unset(i)}))}function u(){h&&h.disconnect(),f&&o(document).off(r,f),w=!1}l.prototype.get=function(t){return this._getList()[t]||null},l.prototype.set=function(t,e){var i=this._getList();o(document).trigger(r,[t,e,i]),i[t]=e,this._saveList(i)},l.prototype.unset=function(t){var e=this._getList();e[t],delete e[t],this._saveList(e)},l.prototype._getList=function(){return JSON.parse(this.internalStorage.getItem(this.key))};var p,h,f,g,m=function(){return s.instance(o(e).find(n))},v=function(){return s.instance(e).getActiveMessageId()},y=function(t){var i=[],n=!1;return o(t).each(function(t,e){e.addedNodes.length&&(i=i.concat(Array.from(e.addedNodes)))}),i.length&&o(i).each(function(t,e){if(o(e).is(".mail-conversation")||o(e).is(".mail-aside"))return n=!0}),n&&m()},w=!(l.prototype._saveList=function(t){this.internalStorage.setItem(this.key,JSON.stringify(t))}),b=function(t){return p.get(t)};i.export({initOnPjaxLoad:!0,init:function(){if(!((t=a.getUrlParameter("r"))&&-1<decodeURIComponent(t).indexOf("mail/mail")||-1<location.pathname.indexOf("mail/mail")))return!!w&&u();w&&u();var t=o(e);h=h||new MutationObserver(d),g=c.prosemirror.api,p=new l,h.observe(t[0],{childList:!0,subtree:!0}),f=function(t,e){i.log.debug("Draft #"+e+" just changed")},o(document).on(r,f),w=!0},DraftsStorage:l})}),humhub.module("mail.mobile",function(t,e,i){var n="mail-breadcrumbs",o=e("ui.widget").Widget,r=e("ui.view"),s=e("util").url,a=o.extend(),c=(a.prototype.getButton=function(){return i(this.anchor)},a.prototype.hideBackButton=function(){this.getButton().hide()},function(){i(document.body).toggleClass("rocket-mobile-body",r.isSmall()&&l())}),l=function(){var t=s.getUrlParameter("r");return t&&-1<decodeURIComponent(t).indexOf("mail/mail")||-1<location.pathname.indexOf("mail/mail")};t.export({init:function(){var t,e;(e=i(".mails-header")).length&&!i("#"+n).length&&((t=document.createElement("div")).id=n,t.dataset.uiWidget="mail.mobile.MailBreadcrumbs",e.append(t),o.instance(t)),l()?(i(window).on("resize",c),c()):i(window).off("resize",c)},MailBreadcrumbs:a,closeConversation:function(t){t&&t.preventDefault(),i(".messages").removeClass("shown"),a.prototype.hideBackButton()}})});